<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brodmann's Areas Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        /* Fixed container style to prevent any layout shifts or flashes */
        .img-container {
            aspect-ratio: 16 / 9;
            background-color: #ffffff !important;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #f1f5f9;
            overflow: hidden;
        }
        /* Force hardware acceleration and prevent re-paints */
        #quiz-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            backface-visibility: hidden;
            transform: translateZ(0);
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.0.0",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
        "htm": "https://esm.sh/htm@3.1.1"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useMemo, useEffect, memo } from 'react';
        import ReactDOM from 'react-dom/client';
        import htm from 'htm';

        const html = htm.bind(React.createElement);

        const BRODMANN_AREAS = [
            { id: '1', number: '1', lobe: 'Parietal', name: 'Primary somatosensory cortex (S1, area 1)', functions: 'Touch, proprioception, somatosensory processing' },
            { id: '2', number: '2', lobe: 'Parietal', name: 'Primary somatosensory cortex (S1, area 2)', functions: 'Touch, proprioception, somatosensory processing' },
            { id: '3', number: '3', lobe: 'Parietal', name: 'Primary somatosensory cortex (S1, area 3)', functions: 'Touch, proprioception, somatosensory processing' },
            { id: '4', number: '4', lobe: 'Frontal', name: 'Primary motor cortex (M1)', functions: 'Voluntary movement control' },
            { id: '5', number: '5', lobe: 'Parietal', name: 'Somatosensory association cortex', functions: 'Integration of sensory information, spatial perception' },
            { id: '6', number: '6', lobe: 'Frontal', name: 'Premotor cortex / Supplementary motor area', functions: 'Planning and coordination of movement' },
            { id: '7', number: '7', lobe: 'Parietal', name: 'Superior parietal lobule', functions: 'Visuomotor integration, spatial orientation' },
            { id: '8', number: '8', lobe: 'Frontal', name: 'Frontal eye fields', functions: 'Voluntary eye movement control' },
            { id: '9', number: '9', lobe: 'Frontal', name: 'Dorsolateral prefrontal cortex', functions: 'Executive function, working memory, planning' },
            { id: '10', number: '10', lobe: 'Frontal', name: 'Frontopolar prefrontal cortex', functions: 'Strategic planning, complex cognition' },
            { id: '11', number: '11', lobe: 'Frontal', name: 'Orbitofrontal cortex', functions: 'Decision-making, emotion regulation' },
            { id: '12', number: '12', lobe: 'Frontal', name: 'Orbitofrontal cortex (ventral)', functions: 'Emotion, reward, social behavior' },
            { id: '17', number: '17', lobe: 'Occipital', name: 'Primary visual cortex (V1)', functions: 'Processing visual stimuli' },
            { id: '18', number: '18', lobe: 'Occipital', name: 'Secondary visual cortex (V2)', functions: 'Visual association, pattern recognition' },
            { id: '19', number: '19', lobe: 'Occipital', name: 'Visual association cortex', functions: 'Higher-order visual processing' },
            { id: '20', number: '20', lobe: 'Temporal', name: 'Inferior temporal gyrus', functions: 'Object recognition, visual memory' },
            { id: '21', number: '21', lobe: 'Temporal', name: 'Middle temporal gyrus', functions: 'Semantic processing, language, auditory integration' },
            { id: '22', number: '22', lobe: 'Temporal', name: 'Superior temporal gyrus', functions: 'Auditory processing, Wernicke’s area (language comprehension)' },
            { id: '23', number: '23', lobe: 'Limbic / Cingulate', name: 'Ventral posterior cingulate cortex', functions: 'Emotion, memory, attention' },
            { id: '24', number: '24', lobe: 'Limbic / Cingulate', name: 'Anterior cingulate cortex', functions: 'Emotion regulation, decision-making, autonomic function' },
            { id: '25', number: '25', lobe: 'Limbic / Cingulate', name: 'Subgenual / ventromedial area', functions: 'Emotion, mood regulation' },
            { id: '37', number: '37', lobe: 'Temporal', name: 'Fusiform gyrus', functions: 'Face, word, and high-level visual recognition' },
            { id: '38', number: '38', lobe: 'Temporal', name: 'Temporal pole', functions: 'Social cognition, emotion, auditory processing' },
            { id: '39', number: '39', lobe: 'Parietal', name: 'Angular gyrus', functions: 'Language, number processing, reading, spatial cognition' },
            { id: '40', number: '40', lobe: 'Parietal', name: 'Supramarginal gyrus', functions: 'Phonological processing, spatial awareness' },
            { id: '41', number: '41', lobe: 'Temporal', name: 'Primary auditory cortex (Heschl’s gyrus)', functions: 'Hearing, auditory processing' },
            { id: '42', number: '42', lobe: 'Temporal', name: 'Auditory association cortex', functions: 'Higher-level auditory perception' },
            { id: '43', number: '43', lobe: 'Insula', name: 'Primary gustatory cortex', functions: 'Taste perception' },
            { id: '44', number: '44', lobe: 'Frontal', name: 'Broca’s area pars opercularis', functions: 'Speech production, language processing' },
            { id: '45', number: '45', lobe: 'Frontal', name: 'Broca’s area pars triangularis', functions: 'Language, semantic processing' },
            { id: '46', number: '46', lobe: 'Frontal', name: 'Dorsolateral prefrontal cortex', functions: 'Executive function, working memory, planning' },
            { id: '47', number: '47', lobe: 'Frontal', name: 'Inferior frontal gyrus (ventrolateral PFC)', functions: 'Language, semantic processing, decision-making' }
        ];

        const QuizMode = { MULTIPLE_CHOICE: 'MCQ', TYPE_ANSWER: 'TYPE' };

        // Memoized completely outside the App to ensure it NEVER re-renders
        const BrainImage = memo(() => {
            return html`
                <div className="img-container">
                    <img 
                        id="quiz-image"
                        src="image1.png" 
                        alt="Brodmann Areas Reference"
                        loading="eager"
                    />
                </div>
            `;
        });

        const shuffleArray = (array) => [...array].sort(() => 0.5 - Math.random());
        const getRandomOptions = (correct, all, count = 4) => {
            const others = Array.from(new Set(all.filter(v => v !== correct))).sort(() => 0.5 - Math.random());
            return [...others.slice(0, count - 1), correct].sort(() => 0.5 - Math.random());
        };

        const validateTypeAnswer = (user, actual) => {
            if (!user) return false;
            const clean = (s) => s.toLowerCase().replace(/[^a-z0-9]/g, '');
            const userC = clean(user);
            const actualC = clean(actual);
            return actualC.includes(userC) || userC.includes(actualC) || (userC.length > 4 && actualC.startsWith(userC.substring(0, 4)));
        };

        const StatusBadge = ({ correct, label }) => html`
            <span className=${`px-2 py-1 rounded text-[10px] font-bold uppercase ${correct ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                ${label} ${correct ? '✓' : '✗'}
            </span>
        `;

        const App = () => {
            const [quizMode, setQuizMode] = useState(null);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [shuffledAreas, setShuffledAreas] = useState([]);
            const [currentAnswer, setCurrentAnswer] = useState({ lobe: '', name: '', functions: '' });
            const [results, setResults] = useState([]);
            const [feedback, setFeedback] = useState(null);

            const startQuiz = (mode) => {
                setShuffledAreas(shuffleArray(BRODMANN_AREAS));
                setQuizMode(mode);
                setCurrentIndex(0);
                setResults([]);
                setFeedback(null);
                setCurrentAnswer({ lobe: '', name: '', functions: '' });
            };

            const currentArea = shuffledAreas[currentIndex];

            const options = useMemo(() => {
                if (!currentArea || quizMode !== QuizMode.MULTIPLE_CHOICE) return null;
                return {
                    lobe: getRandomOptions(currentArea.lobe, BRODMANN_AREAS.map(a => a.lobe)),
                    name: getRandomOptions(currentArea.name, BRODMANN_AREAS.map(a => a.name)),
                    functions: getRandomOptions(currentArea.functions, BRODMANN_AREAS.map(a => a.functions))
                };
            }, [currentArea, quizMode]);

            const handleSubmit = () => {
                const isLobe = quizMode === QuizMode.MULTIPLE_CHOICE ? currentAnswer.lobe === currentArea.lobe : validateTypeAnswer(currentAnswer.lobe, currentArea.lobe);
                const isName = quizMode === QuizMode.MULTIPLE_CHOICE ? currentAnswer.name === currentArea.name : validateTypeAnswer(currentAnswer.name, currentArea.name);
                const isFunc = quizMode === QuizMode.MULTIPLE_CHOICE ? currentAnswer.functions === currentArea.functions : validateTypeAnswer(currentAnswer.functions, currentArea.functions);

                const res = { areaId: currentArea.id, lobeCorrect: isLobe, nameCorrect: isName, functionsCorrect: isFunc };
                setResults(prev => [...prev, res]);
                setFeedback(res);
            };

            const next = () => {
                setFeedback(null);
                setCurrentAnswer({ lobe: '', name: '', functions: '' });
                if (currentIndex < shuffledAreas.length - 1) setCurrentIndex(v => v + 1);
                else setQuizMode('FINISHED');
            };

            if (!quizMode) {
                return html`
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                        <div className="max-w-md w-full bg-white rounded-3xl shadow-xl p-10 text-center">
                            <h1 className="text-3xl font-black text-slate-900 mb-2">Brodmann Explorer</h1>
                            <p className="text-slate-500 mb-8">Master 52 cortical regions</p>
                            <div className="space-y-4">
                                <button onClick=${() => startQuiz(QuizMode.MULTIPLE_CHOICE)} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-colors">Multiple Choice</button>
                                <button onClick=${() => startQuiz(QuizMode.TYPE_ANSWER)} className="w-full py-4 border-2 border-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-50 transition-colors">Recall Mode</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (quizMode === 'FINISHED') {
                return html`
                    <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center">
                        <div className="max-w-2xl w-full bg-white rounded-3xl shadow-xl p-10 text-center mb-6">
                            <h2 className="text-3xl font-black mb-4">Quiz Complete</h2>
                            <button onClick=${() => setQuizMode(null)} className="px-8 py-3 bg-indigo-600 text-white rounded-full font-bold">Restart</button>
                        </div>
                        <div className="max-w-2xl w-full space-y-3 text-sm">
                            ${results.map(r => html`
                                <div className="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm">
                                    <span className="font-bold text-slate-700">Area ${BRODMANN_AREAS.find(a => a.id === r.areaId).number}</span>
                                    <div className="flex gap-2">
                                        <${StatusBadge} correct=${r.lobeCorrect} label="L" />
                                        <${StatusBadge} correct=${r.nameCorrect} label="N" />
                                        <${StatusBadge} correct=${r.functionsCorrect} label="F" />
                                    </div>
                                </div>
                            `)}
                        </div>
                    </div>
                `;
            }

            return html`
                <div className="min-h-screen bg-slate-50 py-8 px-4 flex justify-center">
                    <div className="max-w-3xl w-full">
                        <div className="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
                            <!-- Stable Image -->
                            <${BrainImage} />

                            <div className="bg-indigo-600 p-6 text-center text-white">
                                <h2 className="text-3xl font-black">Area ${currentArea.number}</h2>
                                <p className="text-xs uppercase tracking-widest opacity-80 font-bold">Identification Challenge</p>
                            </div>

                            <div className="p-8 space-y-8">
                                <div>
                                    <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest block mb-3">Lobe Location</label>
                                    ${quizMode === QuizMode.MULTIPLE_CHOICE 
                                        ? html`<div className="grid grid-cols-2 gap-2">
                                            ${options.lobe.map(o => html`
                                                <button onClick=${() => !feedback && setCurrentAnswer(v => ({...v, lobe: o}))} className=${`p-3 text-sm rounded-xl border-2 transition-all ${currentAnswer.lobe === o ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-50 bg-white text-slate-600'}`}>${o}</button>
                                            `)}
                                        </div>`
                                        : html`<input value=${currentAnswer.lobe} onChange=${e => setCurrentAnswer(v => ({...v, lobe: e.target.value}))} className="w-full p-4 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none" placeholder="..." />`
                                    }
                                </div>

                                <div>
                                    <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest block mb-3">Anatomical Name</label>
                                    ${quizMode === QuizMode.MULTIPLE_CHOICE 
                                        ? html`<div className="grid grid-cols-1 gap-2">
                                            ${options.name.map(o => html`
                                                <button onClick=${() => !feedback && setCurrentAnswer(v => ({...v, name: o}))} className=${`p-3 text-left text-sm rounded-xl border-2 transition-all ${currentAnswer.name === o ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-50 bg-white text-slate-600'}`}>${o}</button>
                                            `)}
                                        </div>`
                                        : html`<input value=${currentAnswer.name} onChange=${e => setCurrentAnswer(v => ({...v, name: e.target.value}))} className="w-full p-4 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none" placeholder="..." />`
                                    }
                                </div>

                                <div>
                                    <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest block mb-3">Functional Role</label>
                                    ${quizMode === QuizMode.MULTIPLE_CHOICE 
                                        ? html`<div className="grid grid-cols-1 gap-2">
                                            ${options.functions.map(o => html`
                                                <button onClick=${() => !feedback && setCurrentAnswer(v => ({...v, functions: o}))} className=${`p-3 text-left text-sm rounded-xl border-2 transition-all ${currentAnswer.functions === o ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-50 bg-white text-slate-600'}`}>${o}</button>
                                            `)}
                                        </div>`
                                        : html`<input value=${currentAnswer.functions} onChange=${e => setCurrentAnswer(v => ({...v, functions: e.target.value}))} className="w-full p-4 rounded-xl border-2 border-slate-100 focus:border-indigo-500 outline-none" placeholder="..." />`
                                    }
                                </div>

                                <div className="pt-6 border-t">
                                    ${!feedback ? html`
                                        <button 
                                            disabled=${!currentAnswer.lobe || !currentAnswer.name || !currentAnswer.functions}
                                            onClick=${handleSubmit} 
                                            className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold disabled:opacity-20"
                                        >Submit Answer</button>
                                    ` : html`
                                        <div className="space-y-4">
                                            <div className="p-6 bg-slate-50 rounded-2xl border border-slate-100 text-sm">
                                                <div className="grid grid-cols-3 gap-2 mb-4">
                                                    <StatusBadge correct=${feedback.lobeCorrect} label="Lobe" />
                                                    <StatusBadge correct=${feedback.nameCorrect} label="Name" />
                                                    <StatusBadge correct=${feedback.functionsCorrect} label="Func" />
                                                </div>
                                                <p className="mb-1 text-slate-400 font-bold uppercase text-[9px]">Correction</p>
                                                <p className="text-slate-800"><strong>${currentArea.lobe}</strong> • ${currentArea.name}</p>
                                                <p className="text-slate-600 italic mt-1">${currentArea.functions}</p>
                                            </div>
                                            <button onClick=${next} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold">Next Question</button>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
